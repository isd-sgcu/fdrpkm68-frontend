---
import Layout from "@/layouts/firstdate/WithNavbar.astro";
import { getEventStatus, type EventType } from "@/lib/eventAPI";
import SuccessConfetti from "@/components/common/SuccessConfetti.astro";

const eventType: EventType = 'firstdate';
const eventStatus = await getEventStatus(eventType);

// Check for just registered state from URL params
const url = new URL(Astro.request.url);
const justRegistered = url.searchParams.get('registered') === 'true';

// Check if user should be redirected (already registered but not just registered)
if (eventStatus.isRegistered && !justRegistered) {
  return Astro.redirect('/firstdate/home/');
}
---

<Layout>
  <div class="min-h-screen px-4 py-6 relative z-10">
    <!-- Event Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-white mb-2">CU First Date</h1>
      <p class="text-gray-300">‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡∏Å‡∏û‡∏ö‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏à‡∏∏‡∏¨‡∏≤</p>
    </div>

    <!-- Event Content Based on Status -->
    {!eventStatus.isRegistered && !eventStatus.isLate && !justRegistered && !eventStatus.isComingSoon && (
      <!-- State 1: Not Registered -->
      <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 text-center">
        <h2 class="text-xl font-semibold text-white mb-4">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô</h2>
        <p class="text-gray-300 mb-6">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô CU First Date</p>
        <button 
          id="register-btn"
          class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-8 rounded-lg transition-colors"
        >
          ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏¢
        </button>
      </div>
    )}

    {justRegistered && (
      <!-- State 2: Registration Success (with confetti) -->
      <SuccessConfetti eventName="CU First Date" />
    )}

    {eventStatus.isRegistered && !justRegistered && (
      <!-- State 3: Already Registered -->
      <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 text-center">
        <div class="text-4xl mb-4">‚úÖ</div>
        <h2 class="text-xl font-semibold text-green-400 mb-4">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß</h2>
        <p class="text-gray-300 mb-6">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô CU First Date ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
        <button 
          class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg transition-colors"
          onclick="window.location.href='/firstdate/home/'"
        >
          ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        </button>
      </div>
    )}

    {eventStatus.isLate && (
      <!-- State 4: Registration Closed -->
      <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 text-center">
        <div class="text-4xl mb-4">‚è∞</div>
        <h2 class="text-xl font-semibold text-red-400 mb-4">‡∏õ‡∏¥‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß</h2>
        <p class="text-gray-300 mb-6">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô CU First Date ‡πÑ‡∏î‡πâ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß</p>
        <button 
          class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg transition-colors"
          onclick="window.location.href='/firstdate/home/'"
        >
          ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        </button>
      </div>
    )}

    {eventStatus.isComingSoon && (
      <!-- State 5: Coming Soon -->
      <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 text-center">
        <div class="text-4xl mb-4">üîú</div>
        <h2 class="text-xl font-semibold text-yellow-400 mb-4">Coming Soon</h2>
        <p class="text-gray-300 mb-6">‡∏á‡∏≤‡∏ô CU First Date ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</p>
        <button 
          class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg transition-colors"
          onclick="window.location.href='/firstdate/home/'"
        >
          ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        </button>
      </div>
    )}
  </div>
</Layout>


<script>
  // Handle registration button click
  const registerBtn = document.getElementById('register-btn');
  if (registerBtn) {
    registerBtn.addEventListener('click', async () => {
      registerBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...';
      registerBtn.disabled = true;
      
      try {
        // Simulate API call
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Redirect to show success state
        window.location.href = '/firstdate/firstdate-event/?registered=true';
      } catch (error) {
        registerBtn.textContent = '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏¢';
        registerBtn.disabled = false;
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
      }
    });
  }
</script>